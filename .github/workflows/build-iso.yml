name: Build Guardian OS ISO

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build-components:
    name: Build Guardian Components
    runs-on: ubuntu-24.04
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libssl-dev \
            libsqlite3-dev \
            libdbus-1-dev \
            pkg-config
      
      - name: Build guardian-daemon
        run: |
          cd guardian-components/guardian-daemon
          cargo build --release
      
      - name: Build guardian-wizard
        run: |
          cd guardian-components/guardian-wizard
          cargo build --release
        continue-on-error: true
      
      - name: Build guardian-settings
        run: |
          cd guardian-components/guardian-settings
          cargo build --release
        continue-on-error: true
      
      - name: Build guardian-store
        run: |
          cd guardian-components/guardian-store
          cargo build --release
        continue-on-error: true
      
      - name: Create .deb packages
        run: |
          VERSION=${{ github.event.inputs.version || '1.0.0' }}
          mkdir -p packages
          
          for component in guardian-daemon guardian-wizard guardian-settings guardian-store; do
            echo "Packaging ${component}..."
            
            BINARY="guardian-components/${component}/target/release/${component}"
            if [ ! -f "$BINARY" ]; then
              BINARY="guardian-components/${component}/target/release/${component//-/_}"
            fi
            
            if [ -f "$BINARY" ]; then
              DEB_DIR="packages/${component}_${VERSION}_amd64"
              mkdir -p "${DEB_DIR}/DEBIAN"
              mkdir -p "${DEB_DIR}/usr/bin"
              
              cp "$BINARY" "${DEB_DIR}/usr/bin/${component}"
              chmod 755 "${DEB_DIR}/usr/bin/${component}"
              
              cat > "${DEB_DIR}/DEBIAN/control" << EOF
          Package: ${component}
          Version: ${VERSION}
          Section: misc
          Priority: optional
          Architecture: amd64
          Depends: libssl3, libsqlite3-0
          Maintainer: Guardian OS Team <support@gameguardian.ai>
          Description: ${component} - Guardian OS component
           AI Powered Protection For Families.
          EOF
              
              dpkg-deb --build "${DEB_DIR}"
              echo "‚úì Built ${component}.deb"
            else
              echo "‚ö† Skipping ${component} - binary not found"
            fi
          done
          
          ls -la packages/
      
      - name: Upload component artifacts
        uses: actions/upload-artifact@v4
        with:
          name: guardian-packages
          path: packages/*.deb
          if-no-files-found: warn

  build-iso:
    name: Build ISO
    needs: build-components
    runs-on: ubuntu-24.04
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Download component packages
        uses: actions/download-artifact@v4
        with:
          name: guardian-packages
          path: packages/
        continue-on-error: true
      
      - name: Install ISO build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            debootstrap \
            squashfs-tools \
            xorriso \
            grub-pc-bin \
            grub-efi-amd64-bin \
            mtools \
            dosfstools \
            imagemagick \
            librsvg2-bin
      
      - name: Convert branding assets
        run: |
          cd branding
          chmod +x convert-assets.sh
          ./convert-assets.sh || echo "Asset conversion completed with warnings"
      
      - name: List branding assets
        run: |
          echo "=== Branding assets ==="
          find branding -name "*.png" -o -name "*.svg" | head -30
      
      - name: Prepare ISO configuration
        run: |
          echo "=== ISO Builder Config ==="
          cat iso-builder/config/packages.list
          echo ""
          echo "=== Hooks ==="
          ls -la iso-builder/config/hooks/
      
      - name: Upload branding artifacts
        uses: actions/upload-artifact@v4
        with:
          name: guardian-branding
          path: |
            branding/logo/
            branding/wallpapers/
            branding/plymouth/
            branding/grub/

  release:
    name: Create Release
    needs: build-iso
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Download packages
        uses: actions/download-artifact@v4
        with:
          name: guardian-packages
          path: packages/
        continue-on-error: true
      
      - name: Download branding
        uses: actions/download-artifact@v4
        with:
          name: guardian-branding
          path: branding-output/
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Guardian OS ${{ github.ref_name }}
          body: |
            ## üõ°Ô∏è Guardian OS ${{ github.ref_name }}
            
            **AI Powered Protection For Families**
            
            ### Components Built
            - guardian-daemon - Core safety enforcement service
            - guardian-wizard - First-boot setup wizard
            - guardian-settings - Parental control panel
            - guardian-store - Family-safe app store
            
            ### Branding Assets
            - Logo, wallpapers, Plymouth boot splash, GRUB theme
            
            ### Note
            This is a development release. Full ISO builds require additional setup.
            Individual `.deb` packages can be installed on Pop!_OS/Ubuntu systems.
          files: |
            packages/*.deb
          draft: false
          prerelease: true
